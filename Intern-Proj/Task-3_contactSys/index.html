<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Contact Manager - Local Storage Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Monospace Font for Terminal Look */
        @import url('https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap');
        
        /* --- Hacker Theme Colors --- */
        :root {
            --bg-color: #0d0d0d;
            --text-color: #00ff41; /* Neon Green */
            --accent-color: #ff00ff; /* Neon Magenta */
            --border-color: #008000;
            --scroll-thumb: #00ff41; /* Neon Green Scrollbar Thumb */
            --scroll-track: #1a1a1a; /* Dark track for theme */
        }
        
        body {
            font-family: 'Inconsolata', monospace;
            background-color: var(--bg-color); 
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Main App Card */
        #app {
            background-color: var(--bg-color);
            border: 2px solid var(--border-color);
            box-shadow: 0 0 15px var(--border-color);
            transition: all 0.2s;
        }

        /* Header and Text */
        .text-gray-800, .text-indigo-600 {
            color: var(--text-color) !important;
        }
        .text-gray-500, .text-sm {
            color: var(--border-color) !important;
        }
        
        /* Inputs and Selects (Terminal Look) */
        input[type="text"], input[type="tel"], input[type="email"], textarea {
            background-color: transparent !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
            box-shadow: none !important;
            padding: 8px !important;
            transition: border 0.1s, box-shadow 0.1s;
        }
        input:focus, textarea:focus {
            border-color: var(--text-color) !important;
            box-shadow: 0 0 5px var(--text-color) !important;
            outline: none;
        }

        /* Contact Form Container Background */
        #contact-form-container {
            background-color: #1a1a1a !important; 
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 0 5px var(--border-color) inset;
        }

        /* Contact List Items */
        .bg-white, .bg-gray-50 {
            background-color: #1a1a1a !important; 
            color: var(--text-color);
            border: 1px dashed var(--border-color) !important;
            box-shadow: none !important;
        }
        .hover\:shadow-md:hover {
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* Button Base Style */
        button {
            border: 1px solid var(--text-color) !important;
            box-shadow: 0 0 5px var(--text-color) !important;
            text-shadow: 0 0 2px var(--text-color);
        }
        
        /* Action Buttons (General) */
        .bg-indigo-600, .bg-indigo-500, .bg-red-500, .bg-gray-500, .bg-purple-600 {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            border-color: var(--text-color) !important;
        }
        button:hover {
            background-color: var(--accent-color) !important;
            color: var(--bg-color) !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 10px var(--accent-color) !important;
            text-shadow: none;
        }

        /* Edit/Delete Icons (Invisible text on hover) */
        .text-blue-600, .text-red-600 {
            color: var(--text-color) !important; 
        }
        .hover\:bg-blue-100:hover, .hover\:bg-red-100:hover {
            background-color: var(--accent-color) !important;
            box-shadow: 0 0 5px var(--accent-color);
        }
        .hover\:bg-blue-100:hover svg, .hover\:bg-red-100:hover svg {
            color: var(--bg-color) !important;
        }

        /* Custom Modal */
        #custom-confirm-modal {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #1a1a1a;
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color);
            color: var(--text-color);
        }
        .modal-content button {
            color: var(--text-color) !important;
            border-color: var(--text-color) !important;
        }
        .modal-content button:hover {
            background-color: var(--accent-color) !important;
            color: var(--bg-color) !important;
        }
        .text-gray-600 { /* Modal message text */
            color: var(--border-color) !important;
        }

        /* Gemini Section */
        #draft-loading {
            color: var(--accent-color) !important;
        }
        #draft-output {
            background-color: var(--bg-color) !important;
            border: 1px solid var(--accent-color) !important;
            color: var(--text-color) !important;
        }
        #draft-textarea {
            background-color: var(--bg-color) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        /* --- TOAST NOTIFICATION STYLES --- */
        #toast-notification {
            z-index: 1000;
            background-color: #1a1a1a;
            color: var(--text-color);
            border: 1px solid var(--text-color);
            box-shadow: 0 0 10px var(--text-color);
            animation: slideIn 0.3s ease-out;
            transition: opacity 0.3s ease-in-out;
        }
        .toast-success {
             border-color: var(--text-color);
             box-shadow: 0 0 10px var(--text-color);
        }
        .toast-error {
             border-color: var(--accent-color);
             box-shadow: 0 0 10px var(--accent-color);
             color: var(--accent-color);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* --- HACKER SCROLLBAR STYLES --- */
        /* For WebKit browsers (Chrome, Safari) */
        #contact-list-scroller::-webkit-scrollbar {
            width: 8px;
        }
        #contact-list-scroller::-webkit-scrollbar-track {
            background: var(--scroll-track);
            border: 1px solid var(--border-color);
        }
        #contact-list-scroller::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb);
            border: 1px solid var(--scroll-track);
        }
        /* For Firefox */
        #contact-list-scroller {
            scrollbar-color: var(--scroll-thumb) var(--scroll-track);
            scrollbar-width: thin;
        }
    </style>
</head>
<body class="">

    <div id="app" class="w-full max-w-2xl shadow-xl rounded-none p-6 space-y-6 mx-auto my-auto sm:p-8">
        
        <!-- Header -->
        <header class="border-b pb-4 border-dashed border-green-600">
            <h1 class="text-3xl font-extrabold flex items-center">
                <!-- UserPlus Icon SVG -->
                <svg class="w-8 h-8 mr-3 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                [LOCAL] Contact Manager
            </h1>
            <p class="text-sm mt-1">
                STORAGE: LOCAL | CONTACTS: <span id="total-contacts">0</span>
            </p>
        </header>

        <!-- Search, Add, and Toggle List Buttons -->
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="relative flex-grow">
                <!-- Search Icon SVG -->
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
                <input
                    type="text"
                    id="search-term"
                    placeholder="SCAN: name, phone, or email..."
                    class="w-full pl-10 pr-4 py-2 rounded-none focus:ring-0 transition"
                    oninput="filterContacts()"
                />
            </div>
            
            <button
                id="toggle-form-btn"
                onclick="toggleFormVisibility()"
                class="py-2 px-6 rounded-none font-semibold transition shadow-md whitespace-nowrap bg-indigo-600 hover:bg-indigo-700"
            >
                Add New Contact
            </button>

            <button
                id="toggle-list-btn"
                onclick="toggleListVisibility()"
                class="py-2 px-6 rounded-none font-semibold transition shadow-md whitespace-nowrap bg-gray-500 hover:bg-gray-600"
            >
                Show Contact List
            </button>
        </div>
        
        <!-- Add/Edit Form -->
        <div id="contact-form-container" class="border p-4 rounded-none shadow-inner hidden">
            <h2 id="form-title" class="text-xl font-bold mb-4">EXEC: Add New Contact</h2>
            <form id="contact-form" class="space-y-4" onsubmit="handleFormSubmit(event)"> 
                
                <!-- Name Input -->
                <div class="flex items-center space-x-3 bg-white p-2 rounded-none border-green-600">
                    <!-- User Icon SVG -->
                    <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <input
                        type="text"
                        id="name"
                        placeholder="NAME (REQUIRED)"
                        required
                        class="w-full outline-none"
                    />
                </div>

                <!-- Phone Input -->
                <div class="flex items-center space-x-3 bg-white p-2 rounded-none border-green-600">
                    <!-- Phone Icon SVG -->
                    <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-7.5-7.5 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    <input
                        type="tel"
                        id="phone"
                        placeholder="PHONE (10 DIGITS)"
                        maxlength="10"
                        class="w-full outline-none"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    />
                </div>

                <!-- Email Input -->
                <div class="flex items-center space-x-3 bg-white p-2 rounded-none border-green-600">
                    <!-- Mail Icon SVG -->
                    <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="m22 7-10 7L2 7"/></svg>
                    <input
                        type="email"
                        id="email"
                        placeholder="EMAIL"
                        class="w-full outline-none"
                    />
                </div>
                
                <button
                    type="submit"
                    id="submit-button"
                    class="w-full py-2 rounded-none font-semibold transition shadow-md bg-indigo-600 hover:bg-indigo-700"
                >
                    COMMIT DATA
                </button>
            </form>

            <!-- Gemini Draft Email Section -->
            <div id="gemini-draft-section" class="pt-4 border-t border-green-600 mt-4 hidden">
                <h3 class="text-lg font-bold mb-3">AI ASSISTANT: DRAFT EMAIL</h3>
                <button
                    id="draft-email-btn"
                    onclick="generateDraftEmail()"
                    class="py-2 px-4 rounded-none font-semibold transition shadow-md bg-purple-600 hover:bg-purple-700 flex items-center"
                >
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 7.5a2.4 2.4 0 0 1 0-3h19a2.4 2.4 0 0 1 0 3"/><path d="M3 17.5a2.4 2.4 0 0 1 0-3h18a2.4 2.4 0 0 1 0 3"/><path d="M5 21a2 2 0 0 1-2-2v-1.5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2V19a2 2 0 0 1-2 2z"/></svg>
                    âœ¨ GENERATE DRAFT
                </button>
                
                <div id="draft-loading" class="mt-4 hidden text-sm font-semibold text-accent-color">
                    [LOADING]: GENERATING DRAFT...
                </div>
                
                <div id="draft-output" class="mt-4 hidden p-3 rounded-none shadow-inner space-y-2">
                    <p class="text-sm font-semibold">DRAFT FOR: <span id="draft-name" class="text-green-600"></span></p>
                    <textarea id="draft-textarea" rows="8" class="w-full p-2 border rounded-none text-sm"></textarea>
                    <button onclick="copyToClipboard('draft-textarea')" class="py-1 px-3 rounded-none text-xs font-semibold bg-gray-500 hover:bg-gray-600">
                        COPY TO CLIPBOARD
                    </button>
                </div>
            </div>
            <!-- End Gemini Draft Email Section -->
        </div>


        <!-- Contact List -->
        <!-- LIST STARTS HIDDEN -->
        <div id="contact-list-section" class="space-y-3 hidden"> 
            <h2 class="text-xl font-bold">
                LOG: CONTACT LIST (<span id="contact-count">0</span>)
            </h2>
            
            <!-- SCROLLABLE CONTAINER -->
            <div id="contact-list-scroller" class="h-[30vh] overflow-y-auto pr-3"> 
                <div id="contact-list-container">
                    <!-- Contacts will be rendered here -->
                </div>
                
                <div id="empty-state" class="p-4 border rounded-none flex flex-col items-center justify-center space-y-4 hidden border-green-600">
                    <p id="empty-message" class="italic">>>> DATABASE EMPTY. PRESS BUTTON TO POPULATE.</p>
                    <button
                        id="seed-contacts-btn"
                        onclick="seedContacts()"
                        class="py-2 px-4 rounded-none font-semibold transition shadow-md bg-indigo-400 hover:bg-indigo-500"
                    >
                        [CMD] SEED 20 SAMPLES
                    </button>
                </div>
            </div>
            <!-- END SCROLLABLE CONTAINER -->
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (Hidden by default) -->
    <div id="custom-confirm-modal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div class="modal-content p-6 rounded-none shadow-2xl max-w-sm w-full space-y-4">
            <h3 class="text-xl font-bold">CONFIRM DELETION</h3>
            <p id="confirm-message">WARNING: ARE YOU SURE YOU WANT TO DELETE THIS CONTACT?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="py-2 px-4 rounded-none transition">
                    CANCEL
                </button>
                <button id="confirm-ok-btn" class="py-2 px-4 rounded-none transition bg-red-600 hover:bg-red-700">
                    [CONFIRM] DELETE
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-notification" class="fixed top-4 right-4 p-4 text-xs font-bold rounded-none opacity-0 transition-opacity duration-300 hidden">
        [MESSAGE]
    </div>

    <script type="text/javascript">
        // --- API Keys and Initialization Constants ---
        // --- INTEGRATED LOCAL CREDENTIALS ---
        // These are your credentials now used directly:
        const apiKey = "AIzaSyDz33ZAVEStubTQdz7pTNXakMpHFGRLn3I"; 
        const contactStorageKey = "hacker_contact_manager_contacts"; // New storage key
        const seedStatusKey = "hacker_contact_manager_seeded"; // New status key

        // --- Global Variables ---
        let currentContacts = [];
        let isEditingId = null; 
        let isListVisible = false; // FIX: Default to FALSE
        
        // Mock data with 20 entries and 10-digit phone numbers
        const MOCK_CONTACTS = [
            { id: '1', name: 'Alice Smith', phone: '9876543210', email: 'alice@corp.com' },
            { id: '2', name: 'Bob Johnson', phone: '9988776655', email: 'bob.j@tech.com' },
            { id: '3', name: 'Charlie Brown', phone: '9012345678', email: 'c.brown@sales.com' },
            { id: '4', name: 'Diana Prince', phone: '8765432109', email: 'diana@justice.net' },
            { id: '5', name: 'Ethan Hunt', phone: '8877665544', email: 'ethan.h@agency.org' },
            { id: '6', name: 'Fiona Glenanne', phone: '8098765432', email: 'fiona@spy.com' },
            { id: '7', name: 'George Kirk', phone: '7654321098', email: 'gkirk@starfleet.edu' },
            { id: '8', name: 'Hannah Montana', phone: '7766554433', email: 'hannah@popstar.tv' },
            { id: '9', name: 'Isaac Asimov', phone: '7080901234', email: 'isaac@sci.fi' },
            { id: '10', name: 'Jane Doe', phone: '6543210987', email: 'jane.d@consult.biz' },
            { id: '11', name: 'Ken Masters', phone: '6050403020', email: 'ken.m@fighting.com' },
            { id: '12', name: 'Leia Organa', phone: '5432109876', email: 'leia@rebel.org' },
            { id: '13', name: 'Michael Scott', phone: '5551122330', email: 'michael@dmi.com' },
            { id: '14', name: 'Nancy Drew', phone: '4567890123', email: 'nancy@detective.net' },
            { id: '15', name: 'Owen Grady', phone: '4030201000', email: 'owen@raptors.co' },
            { id: '16', name: 'Peter Parker', phone: '3210987654', email: 'peter@dailybugle.com' },
            { id: '17', name: 'Quinn Fabray', phone: '3322110099', email: 'quinn@cheer.edu' },
            { id: '18', name: 'Riley Matthews', phone: '2109876543', email: 'riley@girlmeets.world' },
            { id: '19', name: 'Steve Rogers', phone: '2211009988', email: 'steve@shield.gov' },
            { id: '20', name: 'Tony Stark', phone: '1098765432', email: 'tony@starkind.com' },
        ];
        
        // --- LOCAL STORAGE UTILITIES ---

        function loadContacts() {
            const data = localStorage.getItem(contactStorageKey);
            try {
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error parsing contacts from localStorage:", e);
                return [];
            }
        }

        function saveContacts(contacts) {
            localStorage.setItem(contactStorageKey, JSON.stringify(contacts));
            currentContacts = contacts;
            filterContacts(); // Re-render the UI automatically
        }
        
        // --- UI/RENDERING FUNCTIONS ---

        /**
         * Shows a themed toast notification.
         * @param {string} message The message to display.
         * @param {string} type 'success' or 'error'.
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = `[STATUS] ${message}`;
            
            toast.classList.remove('hidden', 'toast-success', 'toast-error');
            toast.classList.add(`toast-${type}`);
            
            // Fade in and slide
            toast.style.opacity = 1;
            toast.style.display = 'block';

            // Hide after 3 seconds
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300); // Wait for opacity transition
            }, 3000);
        }

        /**
         * Converts Lucide SVG to HTML string (used for dynamic rendering).
         */
        const getIconHtml = (iconName, className = 'w-4 h-4 mr-2 text-gray-400') => {
            const icons = {
                phone: `<svg class="${className}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-7.5-7.5 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
                mail: `<svg class="${className}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="m22 7-10 7L2 7"/></svg>`,
                edit: `<svg class="${className}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`,
                trash: `<svg class="${className}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            };
            return icons[iconName] || '';
        };
        
        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            document.execCommand('copy');
            showToast("Draft copied to clipboard!", 'success');
        }

        /**
         * Renders the contacts based on the current state.
         */
        function renderContacts(contactsToRender) {
            const container = document.getElementById('contact-list-container');
            const totalCountSpan = document.getElementById('total-contacts');
            const filteredCountSpan = document.getElementById('contact-count');
            const emptyState = document.getElementById('empty-state');
            const emptyMessage = document.getElementById('empty-message');
            const searchTerm = document.getElementById('search-term').value;
            const contactListSection = document.getElementById('contact-list-section');


            // Only render/show the list if the user has toggled visibility ON
            if (!isListVisible) {
                contactListSection.classList.add('hidden');
                return;
            } else {
                contactListSection.classList.remove('hidden');
            }


            container.innerHTML = '';
            filteredCountSpan.textContent = contactsToRender.length;
            totalCountSpan.textContent = currentContacts.length;

            if (contactsToRender.length === 0) {
                emptyState.classList.remove('hidden');
                if (searchTerm) {
                    emptyMessage.textContent = '>>> NO MATCHES FOUND. RE-SCAN.';
                    document.getElementById('seed-contacts-btn').style.display = 'none';
                } else {
                    emptyMessage.textContent = '>>> DATABASE EMPTY. PRESS BUTTON TO POPULATE.';
                    document.getElementById('seed-contacts-btn').style.display = 'block';
                }
                return;
            }
            emptyState.classList.add('hidden');

            const ul = document.createElement('ul');
            ul.className = 'space-y-2';

            contactsToRender.forEach(contact => {
                const li = document.createElement('li');
                // The parent li is a flex container to align items-center
                li.className = 'bg-white p-4 border border-gray-200 rounded-none shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center transition hover:shadow-md';
                
                // --- FIXED STRUCTURE FOR ALIGNMENT AND FUNCTIONALITY ---
                li.innerHTML = `
                    <div class="flex-grow space-y-1 mb-2 sm:mb-0">
                        <p class="text-lg font-semibold text-green-600">${contact.name}</p>
                        ${contact.phone ? `<p class="flex items-center text-green-600 text-sm">${getIconHtml('phone', 'w-4 h-4 mr-2 text-green-600')} ${contact.phone}</p>` : ''}
                        ${contact.email ? `<p class="flex items-center text-green-600 text-sm">${getIconHtml('mail', 'w-4 h-4 mr-2 text-green-600')} ${contact.email}</p>` : ''}
                    </div>
                    
                    <!-- BUTTON CONTAINER - flex-shrink-0 ensures buttons stay right -->
                    <div class="flex space-x-2 flex-shrink-0">
                        <!-- EDIT BUTTON - w-8 h-8 ensures button area is large enough to be clickable/visible -->
                        <button onclick="editContact(
                            '${contact.id}', 
                            '${contact.name.replace(/'/g, "\\'")}', 
                            '${contact.phone}', 
                            '${contact.email.replace(/'/g, "\\'")}'
                        )" 
                                class="p-2 w-8 h-8 rounded-full text-blue-600 hover:bg-blue-100 transition flex items-center justify-center" title="Edit Contact">
                            ${getIconHtml('edit', 'w-5 h-5')}
                        </button>
                        <!-- DELETE BUTTON -->
                        <button onclick="showDeleteConfirm(
                            '${contact.id}', 
                            '${contact.name.replace(/'/g, "\\'")}'
                        )" 
                                class="p-2 w-8 h-8 rounded-full text-red-600 hover:bg-red-100 transition flex items-center justify-center" title="Delete Contact">
                            ${getIconHtml('trash', 'w-5 h-5')}
                        </button>
                    </div>
                `;
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }

        /**
         * Filters the contacts array based on the search term and renders the results.
         */
        function filterContacts() {
            const searchTerm = document.getElementById('search-term').value.toLowerCase();
            const filtered = currentContacts.filter(contact =>
                contact.name.toLowerCase().includes(searchTerm) ||
                (contact.phone && contact.phone.includes(searchTerm)) ||
                (contact.email && contact.email.toLowerCase().includes(searchTerm))
            );
            renderContacts(filtered);
        }

        /**
         * Clears the form inputs and resets the editing state.
         */
        function resetForm() {
            document.getElementById('contact-form').reset();
            document.getElementById('form-title').textContent = 'EXEC: Add New Contact';
            document.getElementById('submit-button').textContent = 'COMMIT DATA';
            document.getElementById('submit-button').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('submit-button').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            
            // Hide Gemini section on reset/add
            document.getElementById('gemini-draft-section').classList.add('hidden');
            document.getElementById('draft-output').classList.add('hidden');
            isEditingId = null;
        }

        /**
         * Toggles the visibility of the contact form.
         */
        function toggleFormVisibility() {
            const formContainer = document.getElementById('contact-form-container');
            const toggleBtn = document.getElementById('toggle-form-btn');

            if (formContainer.classList.contains('hidden')) {
                formContainer.classList.remove('hidden');
                toggleBtn.textContent = 'Close Form';
                toggleBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                toggleBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                resetForm();
            } else {
                formContainer.classList.add('hidden');
                toggleBtn.textContent = 'Add New Contact';
                toggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                toggleBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                resetForm();
            }
        }
        
        /**
         * Toggles the visibility of the contact list section.
         */
        function toggleListVisibility() {
            const toggleBtn = document.getElementById('toggle-list-btn');
            isListVisible = !isListVisible;

            if (isListVisible) {
                toggleBtn.textContent = 'Hide Contact List';
                toggleBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                toggleBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                filterContacts(); // Re-render to show list
            } else {
                toggleBtn.textContent = 'Show Contact List';
                toggleBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                toggleBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                document.getElementById('contact-list-section').classList.add('hidden');
            }
        }


        // --- Gemini API Functions ---
        async function generateDraftEmail() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const draftLoading = document.getElementById('draft-loading');
            const draftOutput = document.getElementById('draft-output');
            const draftTextarea = document.getElementById('draft-textarea');
            const draftNameSpan = document.getElementById('draft-name');

            if (!name || !email) {
                console.error("Name and Email are required to draft an email.");
                return;
            }

            draftLoading.classList.remove('hidden');
            draftOutput.classList.add('hidden');

            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            const prompt = `Draft a concise, professional, and friendly email to the contact named: ${name}. The email should politely introduce yourself, reference their professional email address (${email}), and propose a brief, high-level meeting or connection. The tone should be formal yet engaging. Start directly with the subject line.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a professional email drafting assistant. Provide ONLY the full email draft, including the subject line and salutations, in plain text. Do not include any introductory or concluding commentary." }]
                },
            };

            const maxRetries = 3;
            let response = null;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success! Exit the loop
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API returned status code ${response.status}`);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    if (attempt === maxRetries - 1) throw error;
                }
            }
            
            draftLoading.classList.add('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating draft.";
                
                draftNameSpan.textContent = name;
                draftTextarea.value = text.trim();
                draftOutput.classList.remove('hidden');
            } else {
                draftTextarea.value = "Failed to generate draft after retries. Check API key or console for details.";
                draftOutput.classList.remove('hidden');
            }
        }


        // --- LOCAL STORAGE CRUD OPERATIONS ---

        /**
         * Checks if a contact with the given phone or email already exists.
         * @param {string} phone 
         * @param {string} email 
         * @returns {boolean} True if a duplicate is found.
         */
        function checkIfContactExists(phone, email) {
            // We check against the current contacts list which is loaded from localStorage.
            const isDuplicate = currentContacts.some(contact => {
                // If contact is being edited, allow it to match its own details
                if (contact.id === isEditingId) return false; 
                
                // Check if phone or email matches an existing entry
                const phoneMatch = phone && contact.phone === phone;
                const emailMatch = email && contact.email === email;
                
                return phoneMatch || emailMatch;
            });

            return isDuplicate;
        }

        /**
         * Handles form submission for adding or editing a contact.
         */
        async function handleFormSubmit(event) {
            event.preventDefault(); 
            // No Firebase dependency check needed here.

            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();

            // Validation: Name is mandatory
            if (!name) {
                showToast("Name is required.", 'error');
                return;
            }

            // Validation: Phone must be exactly 10 digits if provided
            if (phone && (phone.length !== 10 || !/^\d+$/.test(phone))) {
                showToast("Phone number must be exactly 10 digits.", 'error');
                return;
            }
            
            // --- Duplicate Check ---
            const isDuplicate = checkIfContactExists(phone, email);
            if (isDuplicate) {
                showToast("Error: A contact with this Phone or Email already exists!", 'error');
                return;
            }
            // --- END Duplicate Check ---

            const contactData = { name, phone, email };
            let updatedContacts = [...currentContacts];
            
            if (isEditingId) {
                // UPDATE operation
                updatedContacts = updatedContacts.map(contact => 
                    contact.id === isEditingId ? { ...contact, ...contactData } : contact
                );
                showToast(`Contact ${name} updated successfully.`, 'success');
            } else {
                // CREATE operation
                const newId = crypto.randomUUID(); // Generate a unique ID
                updatedContacts.push({ id: newId, ...contactData });
                showToast(`New contact ${name} added successfully.`, 'success');
            }

            saveContacts(updatedContacts); // Save to localStorage
            
            // Force list visibility ON and update button text after saving
            isListVisible = true;
            const toggleListBtn = document.getElementById('toggle-list-btn');
            toggleListBtn.textContent = 'Hide Contact List';
            toggleListBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            toggleListBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
            
            filterContacts(); // Call render immediately
            toggleFormVisibility(); // Hide form after successful save
        }

        /**
         * Populates the form fields for editing.
         */
        function editContact(id, name, phone, email) {
            if (document.getElementById('contact-form-container').classList.contains('hidden')) {
                 toggleFormVisibility();
            }
            
            document.getElementById('name').value = name;
            document.getElementById('phone').value = phone;
            document.getElementById('email').value = email;

            document.getElementById('form-title').textContent = 'EXEC: Edit Contact';
            document.getElementById('submit-button').textContent = 'SAVE CHANGES';
            document.getElementById('submit-button').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('submit-button').classList.add('bg-green-600', 'hover:bg-green-700');
            
            // Show Gemini section on Edit
            document.getElementById('gemini-draft-section').classList.remove('hidden');
            
            // Clear any previous draft output
            document.getElementById('draft-output').classList.add('hidden');
            document.getElementById('draft-textarea').value = '';

            isEditingId = id;
        }
        
        /**
         * Shows the custom confirmation modal for deletion.
         */
        function showDeleteConfirm(id, name) {
            const modal = document.getElementById('custom-confirm-modal');
            const message = document.getElementById('confirm-message');
            
            message.innerHTML = `WARNING: DELETE **${name}** PERMANENTLY?`;
            modal.style.display = 'flex';
            
            // Set up the OK button action
            document.getElementById('confirm-ok-btn').onclick = () => {
                modal.style.display = 'none';
                deleteContact(id, name);
            };
            
            // Set up the Cancel button action
            document.getElementById('confirm-cancel-btn').onclick = () => {
                modal.style.display = 'none';
            };
        }

        /**
         * Deletes a contact from localStorage.
         */
        function deleteContact(id, name) {
            const updatedContacts = currentContacts.filter(contact => contact.id !== id);
            saveContacts(updatedContacts);
            showToast(`Contact ${name} deleted.`, 'success');
        }

        /**
         * Adds all mock contacts to the database (localStorage).
         * This button only appears if the list is empty and should only be clicked once.
         */
        function seedContacts() {
            const seeded = localStorage.getItem(seedStatusKey);
            if (seeded) return; 

            // 1. Add mock contacts with unique IDs
            const contactsToSeed = MOCK_CONTACTS.map(contact => ({
                ...contact,
                id: crypto.randomUUID()
            }));
            
            // 2. Load existing and append new ones (though list should be empty here)
            let existingContacts = loadContacts();
            existingContacts.push(...contactsToSeed);
            
            // 3. Save, update status, and show toast
            saveContacts(existingContacts);
            localStorage.setItem(seedStatusKey, 'true');

            showToast(`Successfully added ${MOCK_CONTACTS.length} mock contacts!`, 'success');
            
            // Note: Since default is hidden, we won't toggle visibility here.
        }


        // --- Initialization ---

        window.onload = function() {
            // Load existing contacts from storage
            currentContacts = loadContacts();

            // If the list is empty and hasn't been seeded, seed it automatically
            if (currentContacts.length === 0 && !localStorage.getItem(seedStatusKey)) {
                seedContacts();
            }
            
            // Initial render is NOT performed if list is hidden (isListVisible=false).
            // It will be rendered when the user clicks 'Show Contact List'.
            console.log("Application initialized using local storage.");
        };

    </script>
</body>
</html>
